<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendrier (mardi)</title>

  <style>
    *{ box-sizing: border-box; }

    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    /* =========================
       PALETTE TSLSJ (Normes)
       Bleu #3A5DAE | Bleu foncé #1B365D | Noir K100 | Gris K60 (~#666)
       ========================= */
    :root{
      --tslsj-blue: #3A5DAE;
      --tslsj-navy: #1B365D;
      --tslsj-black:#000000;
      --tslsj-gray: #666666; /* K60 ≈ #666666 en web */

      /* tints (dérivés des couleurs ci-dessus) */
      --tint-blue-06: rgba(58,93,174,.06);
      --tint-blue-10: rgba(58,93,174,.10);
      --tint-blue-16: rgba(58,93,174,.16);

      --tint-navy-06: rgba(27,54,93,.06);
      --tint-navy-10: rgba(27,54,93,.10);
      --tint-navy-16: rgba(27,54,93,.16);

      --tint-black-03: rgba(0,0,0,.03);
      --tint-black-06: rgba(0,0,0,.06);
      --tint-black-10: rgba(0,0,0,.10);
      --tint-black-14: rgba(0,0,0,.14);

      --radius-lg: 14px;
      --radius-md: 12px;
      --shadow-sm: 0 2px 10px rgba(0,0,0,.06);

      /* 30 minutes */
      --half: 74px;
    }

    body{
      font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:20px;
      color: var(--tslsj-navy);
      background: linear-gradient(180deg, var(--tint-blue-06), transparent 220px);
    }

    h2{
      margin: 0 0 14px 0;
      font-weight: 700;
      letter-spacing: .2px;
      color: var(--tslsj-navy);
    }

    .muted{ opacity:.75; color: var(--tslsj-gray); }

    /* ===== Barre de contrôle ===== */
    .bar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:wrap;
      margin-bottom:16px;
      padding: 12px;
      border: 1px solid var(--tint-black-10);
      border-radius: var(--radius-lg);
      background: #fff;
      box-shadow: var(--shadow-sm);
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12.5px;
      font-weight: 600;
      color: var(--tslsj-navy);
    }

    select,input,button{
      padding:10px 12px;
      font-size:14px;
      border-radius: 12px;
      border: 1px solid var(--tint-black-14);
      background:#fff;
      color: var(--tslsj-navy);
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease, transform .12s ease, filter .12s ease;
    }

    select:focus, input:focus{
      border-color: rgba(58,93,174,.55);
      box-shadow: 0 0 0 4px rgba(58,93,174,.12);
    }

    button{
      cursor:pointer;
      font-weight: 700;
      border-color: rgba(27,54,93,.25);
      background: var(--tslsj-blue);
      color: #fff;
    }
    button:hover{
      filter: brightness(.97);
      transform: translateY(-1px);
    }
    button:active{ transform: translateY(0); }

    /* ===== Matrice ===== */
    .matrix{
      border:1px solid var(--tint-black-10);
      border-radius: var(--radius-lg);
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow-sm);
    }

    .matrix-header{
      display:grid;
      grid-template-columns: 90px repeat(4, 1fr);
      background: var(--tint-black-03);
      border-bottom:1px solid var(--tint-black-10);
    }
    .matrix-header .h{
      padding:12px 10px;
      font-weight:800;
      border-right:1px solid var(--tint-black-10);
      color: var(--tslsj-navy);
      letter-spacing:.2px;
    }
    .matrix-header .h:last-child{border-right:0}

    .matrix-body{
      display:grid;
      grid-template-columns: 90px repeat(4, 1fr);
      position:relative;
    }

    .time-col{
      background: var(--tint-black-03);
      border-right:1px solid var(--tint-black-10)
    }
    .time-cell{
      height: var(--half);
      padding: 0 10px;
      display:flex;
      align-items:center;
      border-top:1px solid var(--tint-black-10);
      font-variant-numeric:tabular-nums;
      color: var(--tslsj-navy);
      font-weight:600;
      font-size: 12.5px;
    }
    .time-cell:first-child{border-top:0}

    .cat-col{
      position:relative;
      display:grid;
      grid-auto-rows: var(--half);
      border-right:1px solid var(--tint-black-10);

      /* lanes (chevauchements) */
      grid-template-columns: repeat(var(--lanes, 1), 1fr);
      align-content:start;
      background: #fff;
    }
    .cat-col:last-child{border-right:0}

    /* lignes horizontales visibles même si vide */
    .cat-col::before{
      content:"";
      position:absolute;
      inset:0;
      background: repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent calc(var(--half) - 1px),
        var(--tint-black-10) calc(var(--half) - 1px),
        var(--tint-black-10) var(--half)
      );
      pointer-events:none;
      z-index:0;
    }

    /* Card */
    .event{
      position:relative;
      z-index:1;
      margin:8px;
      padding:8px 10px;
      border:1px solid var(--tint-black-14);
      border-radius: var(--radius-md);
      background:#fff;
      text-decoration:none;
      color:inherit;
      transition: filter .12s ease, transform .12s ease, box-shadow .12s ease;
      display:block;
      overflow:hidden;
    }

    .event:hover{
      filter: brightness(0.985);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
    }

    .event.disabled{ cursor: default; }
    .event.disabled:hover{ filter:none; transform:none; box-shadow:none; }

    .event .t{
      font-weight:700;
      font-size:15px;
      line-height:1.2;

      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 4;
      overflow: hidden;
    }

    .event .m{
      font-size:12px;
      margin-top:3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--tslsj-gray);
      font-weight:600;
    }

    /* Tag (tu voulais garder des tags de couleurs différentes) */
    .tag{
      display:inline-block;
      margin-top:4px;
      padding:3px 8px;
      font-size:11px;
      font-weight:800;
      border-radius:10px;
      border:1px solid var(--tint-black-14);
      width:fit-content;
    }

    /* CTA: souligné + flèche */
    .cta{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      font-weight:800;

      background:none !important;
      box-shadow:none !important;
      border:none;
      border-bottom:1px solid var(--tint-black-14);
      padding:0 0 2px 0;
      width:fit-content;
      pointer-events:auto;

      white-space: nowrap;
    }

    .cta,
    .cta:link,
    .cta:visited,
    .cta:hover,
    .cta:active,
    .cta:focus{
      background:none !important;
      box-shadow:none !important;
      outline:none !important;
      text-decoration:none;
    }

    .arrow{
      display:inline-block;
      margin-left:4px;
      transition: transform .12s ease;
    }
    .event:hover .arrow{ transform: translateX(2px); }

    /* =========================
       Couleurs par catégorie (TSLSJ)
       - Les cartes: tints + barre accent à gauche (cohérent)
       - Les tags: couleurs différentes (bleu / bleu foncé / gris / mix)
       ========================= */

    /* Coworking (bleu) */
    .type-coworking{
      background: var(--tint-blue-10);
      border-color: rgba(58,93,174,.30);
      box-shadow: inset 4px 0 0 0 var(--tslsj-blue);
    }
    .type-coworking .tag{
      background: var(--tslsj-blue);
      border-color: rgba(58,93,174,.45);
      color: #fff;
    }
    .type-coworking .cta{ color: var(--tslsj-blue); border-bottom-color: rgba(58,93,174,.45); }

    /* Réseautage (bleu foncé) */
    .type-reseautage{
      background: var(--tint-navy-10);
      border-color: rgba(27,54,93,.28);
      box-shadow: inset 4px 0 0 0 var(--tslsj-navy);
    }
    .type-reseautage .tag{
      background: var(--tslsj-navy);
      border-color: rgba(27,54,93,.45);
      color: #fff;
    }
    .type-reseautage .cta{ color: var(--tslsj-navy); border-bottom-color: rgba(27,54,93,.45); }

    /* Atelier (gris) */
    .type-atelier{
      background: var(--tint-black-06);
      border-color: rgba(0,0,0,.16);
      box-shadow: inset 4px 0 0 0 var(--tslsj-gray);
    }
    .type-atelier .tag{
      background: var(--tslsj-gray);
      border-color: rgba(0,0,0,.18);
      color: #fff;
    }
    .type-atelier .cta{ color: var(--tslsj-gray); border-bottom-color: rgba(0,0,0,.18); }

    /* Conseils (mix bleu + foncé pour se distinguer) */
    .type-conseils{
      background: var(--tint-blue-10);
      border-color: rgba(27,54,93,.24);
      box-shadow: inset 4px 0 0 0 var(--tslsj-navy);
    }
    .type-conseils .tag{
      background: linear-gradient(90deg, var(--tslsj-navy), var(--tslsj-blue));
      border-color: rgba(27,54,93,.35);
      color: #fff;
    }
    .type-conseils .cta{ color: var(--tslsj-navy); border-bottom-color: rgba(27,54,93,.35); }

    /* Diner pleine largeur */
    .event.full{
      grid-column: 1 / -1;
      max-width:none;
      pointer-events:auto;
    }

    /* Les cartes peuvent scroller si trop de contenu */
    .cat-col .event{ overflow:auto; }
  </style>
</head>

<body>
  <h2>Les mardis Oriance Agora</h2>

  <div class="bar">
    <label>Date:
      <input id="date" type="date" />
    </label>

    <label>Filtre:
      <select id="filtre">
        <option value="">Tous</option>
      </select>
    </label>

    <button id="reload">Recharger</button>
    <span class="muted" id="status"></span>
  </div>

  <div class="matrix" id="grid">
    <div class="matrix-header" id="header"></div>
    <div class="matrix-body" id="body"></div>
  </div>

  <script>
    // ====== WORKER CLOUDFLARE ======
    // Le token Airtable est maintenant sécurisé dans le Worker Cloudflare
    // Plus besoin de l'exposer ici!
    // =========================

    // Champs Airtable (noms exacts)
    const F_DATE = "Date activité";
    const F_TITLE = "Titre";
    const F_TYPE = "Type d’activité";

    // IMPORTANT: on se base sur heures réelles (pas SlotIndex)
    const F_START_TIME = "Heure début";
    const F_END_TIME   = "Heure fin";

    // Optionnel (si tu l’as)
    const F_TIME_LABEL = "Heure_affichage";

    const $ = (id) => document.getElementById(id);

    // Grille 09:00 -> 17:00, pas 30 minutes
    const START_MIN = 9*60;
    const END_MIN   = 17*60;
    const STEP_MIN  = 30;

    function pad2(n){ return String(n).padStart(2,"0"); }
    function minutesToHHMM(min){
      const h = Math.floor(min/60);
      const m = min % 60;
      return pad2(h) + ":" + pad2(m);
    }

    function parseTimeToMinutes(v){
      if(!v) return null;

      // Airtable renvoie souvent ISO date+heure
      if (typeof v === "string" && v.includes("T")){
        const d = new Date(v);
        if (!isNaN(d)) return d.getHours()*60 + d.getMinutes();
      }

      // Ou parfois "09:00"
      const s = String(v).trim().toLowerCase();
      const m = s.match(/^(\d{1,2}):(\d{2})(am|pm)?$/);
      if(!m) return null;

      let hh = Number(m[1]);
      const mm = Number(m[2]);
      const ampm = m[3];

      if (ampm){
        if (ampm === "pm" && hh !== 12) hh += 12;
        if (ampm === "am" && hh === 12) hh = 0;
      }
      return hh*60 + mm;
    }

    function minutesToLine(min){
      // lignes CSS grid 1-based
      return Math.round((min - START_MIN) / STEP_MIN) + 1;
    }

    function toCssType(typeRaw){
      return (typeRaw || "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "-");
    }

    function typeToColKey(typeRaw){
      const t = (typeRaw || "").toLowerCase();
      if (t.includes("cowork")) return "coworking";
      if (t.includes("reseau") || t.includes("réseau") || t.includes("reseautage") || t.includes("réseautage")) return "reseautage";
      if (t.includes("atelier")) return "atelier";
      if (t.includes("conseil")) return "conseils";
      return null;
    }

function toYMD(v){
  if(!v) return "";
  // Si c'est déjà "YYYY-MM-DD"
  if (typeof v === "string" && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const d = new Date(v);
  if (isNaN(d)) return "";
  return d.toISOString().slice(0,10);
}


    async function fetchRecords(){
      const dateISO = $("date").value;
      const type = $("filtre").value;

      let formula = "DATETIME_FORMAT({" + F_DATE + "}, 'YYYY-MM-DD')='" + dateISO + "'";
      if (type) formula = "AND(" + formula + ", {" + F_TYPE + "}='" + type + "')";

     const url = new URL("https://flat-credit-0421.lcollard.workers.dev/");
      url.searchParams.set("pageSize","100");
      url.searchParams.set("filterByFormula", formula);

      const res = await fetch(url.toString());

      if(!res.ok) throw new Error("Airtable API error " + res.status);
      const data = await res.json();
      return data.records.map(r => ({ id:r.id, ...r.fields }));
    }

    function buildTypeOptions(records){
      const types = new Set();
      records.forEach(r => r[F_TYPE] && types.add(r[F_TYPE]));
      const sel = $("filtre");
      const current = sel.value;
      sel.innerHTML = '<option value="">Tous</option>' +
        Array.from(types).sort().map(t => '<option>' + t + '</option>').join("");
      sel.value = current;
    }

    function render(records){
      const header = $("header");
      const body = $("body");
      header.innerHTML = "";
      body.innerHTML = "";

      const categories = [
        { key:"coworking", label:"Coworking" },
        { key:"reseautage", label:"Réseautage" },
        { key:"atelier", label:"Ateliers" },
        { key:"conseils", label:"Conseils" }
      ];

      // Header
      const h0 = document.createElement("div");
      h0.className = "h";
      h0.textContent = "";
      header.appendChild(h0);

      categories.forEach(c => {
        const h = document.createElement("div");
        h.className = "h";
        h.textContent = c.label;
        header.appendChild(h);
      });

      // Colonne des heures (30 minutes)
      const timeCol = document.createElement("div");
      timeCol.className = "time-col";

      for(let m = START_MIN; m < END_MIN; m += STEP_MIN){
        const tc = document.createElement("div");
        tc.className = "time-cell";
        // Affiche seulement l'heure pleine
        tc.textContent = (m % 60 === 0) ? minutesToHHMM(m) : "";
        timeCol.appendChild(tc);
      }
      body.appendChild(timeCol);

      // Colonnes catégories
      const cols = {};
      categories.forEach(c => {
        const col = document.createElement("div");
        col.className = "cat-col";
        body.appendChild(col);
        cols[c.key] = col;
      });

      // Normalisation events (minutes)
      const events = records.map(r => {
        const title = r[F_TITLE] || "(Sans titre)";
        const type = r[F_TYPE] || "";
        const colKey = typeToColKey(type);

        const startMin = parseTimeToMinutes(r[F_START_TIME]);
        const endMin   = parseTimeToMinutes(r[F_END_TIME]);

        if (!Number.isFinite(startMin) || !Number.isFinite(endMin)) return null;
        if (endMin <= startMin) return null;

        // clamp dans la grille
        const s = Math.max(startMin, START_MIN);
        const e = Math.min(endMin, END_MIN);

        const label = r[F_TIME_LABEL] || (minutesToHHMM(s) + " – " + minutesToHHMM(e));
        const actionLabel = r["Action"] || "";
        const actionUrl = r["ActionURL"] || "";

        return { title, type, colKey, s, e, label, actionLabel, actionUrl };
      }).filter(Boolean);

      // Lanes (chevauchements) PAR CAT
      const byCat = {};
      events.forEach(ev => {
        if(!ev.colKey) return;
        (byCat[ev.colKey] ||= []).push(ev);
      });

      Object.keys(byCat).forEach(key => {
        const list = byCat[key].sort((a,b) => a.s - b.s || a.e - b.e);
        const lanesEnd = [];

        list.forEach(ev => {
          let lane = lanesEnd.findIndex(end => end <= ev.s);
          if(lane === -1){
            lanesEnd.push(ev.e);
            lane = lanesEnd.length - 1;
          }else{
            lanesEnd[lane] = ev.e;
          }
          ev.lane = lane + 1;
        });

        if (cols[key]) cols[key].style.setProperty("--lanes", String(lanesEnd.length || 1));
      });

      // Render
      events.forEach(ev => {
        const clickable = !!ev.actionUrl && !!ev.actionLabel;
        const card = document.createElement(clickable ? "a" : "div");

        const typeClass = toCssType(ev.type);
        card.className = "event type-" + typeClass + (clickable ? "" : " disabled");

        const startLine = minutesToLine(ev.s);
        const endLine   = minutesToLine(ev.e);
        card.style.gridRow = startLine + " / " + endLine;

        if (clickable){
          card.href = ev.actionUrl;
          card.target = "_blank";
          card.rel = "noopener noreferrer";
        }

        card.innerHTML =
          '<div class="t">' + ev.title + '</div>' +
          (ev.type ? '<div class="tag">' + ev.type + '</div>' : '') +
          '<div class="m">' + ev.label + '</div>';

        if (clickable){
          const cta = document.createElement("div");
          cta.className = "cta";
          cta.innerHTML = ev.actionLabel + ' <span class="arrow">→</span>';
          card.appendChild(cta);
        }

        // Diner = pleine largeur
        if ((ev.title || "").trim().toLowerCase() === "diner") {
          card.classList.add("full");
        }

        // Catégorie obligatoire
        if (ev.colKey && cols[ev.colKey]){
          if (ev.lane) card.style.gridColumn = String(ev.lane);
          cols[ev.colKey].appendChild(card);
        }
      });
    }

    async function load(){
      $("status").textContent = "Chargement…";
      try{
        const records = await fetchRecords();
        buildTypeOptions(records);
        render(records);
        $("status").textContent = records.length + " activité(s)";
      }catch(e){
        $("status").textContent = "Erreur: " + e.message;
        console.error(e);
      }
    }

    // Par défaut: 3 mars 2026
    $("date").value = "2026-03-03";

    $("reload").addEventListener("click", load);
    $("filtre").addEventListener("change", load);

    load();
  </script>
</body>
</html>
