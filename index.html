<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendrier (mardis)</title>

  <style>
    *{ box-sizing:border-box; }

    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    /* =========================
      PALETTE TSLSJ (Normes)
      Bleu #3A5DAE | Bleu foncé #1B365D | Noir K100 | Gris K60 (~#666)
      + Accents complémentaires (discrets, pour moderniser sans dénaturer)
      ========================= */
    :root{
      --tslsj-blue: #3A5DAE;
      --tslsj-navy: #1B365D;
      --tslsj-black: #111;
      --tslsj-gray: #666;

      /* Accents complémentaires (utilisés avec parcimonie) */
      --accent-sage: #2E7D6B;
      --accent-coral: #E06A4A;

      /* Tints neutres */
      --bg: #F7F9FC;
      --panel: rgba(255,255,255,.86);
      --panel-solid: #fff;

      --tint-black-06: rgba(0,0,0,.06);
      --tint-black-08: rgba(0,0,0,.08);
      --tint-black-12: rgba(0,0,0,.12);
      --tint-black-14: rgba(0,0,0,.14);
      --tint-black-18: rgba(0,0,0,.18);

      /* Spacing */
      --r: 18px;
      --shadow: 0 14px 30px rgba(27,54,93,.10);
      --shadow2: 0 10px 18px rgba(0,0,0,.08);

      /* Grille horaire: demi-heures */
      --half: 72px; /* hauteur par demi-heure (ajustable) */
      --timecol: 86px;
    }

    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--tslsj-black);
      background:
        radial-gradient(1100px 450px at 20% -10%, rgba(58,93,174,.12), transparent 55%),
        radial-gradient(900px 420px at 90% 0%, rgba(46,125,107,.10), transparent 55%),
        radial-gradient(900px 420px at 70% 80%, rgba(224,106,74,.10), transparent 60%),
        var(--bg);
    }

    .page{
      max-width: 1180px;
      margin: 0 auto;
      padding: 22px;
    }

    h2{
      margin: 8px 0 10px;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .2px;
      color: var(--tslsj-navy);
    }

    .sub{
      margin: 0 0 14px;
      color: rgba(27,54,93,.72);
      font-size: 13px;
      line-height: 1.35;
    }

    /* ===== Toolbar ===== */
    .bar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap: 10px 12px;

      background: var(--panel);
      border: 1px solid rgba(27,54,93,.10);
      border-radius: var(--r);
      padding: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);

      position: sticky;
      top: 12px;
      z-index: 12;
    }

    .bar label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
      color: rgba(27,54,93,.78);
      min-width: 180px;
    }

    input[type="date"], select{
      appearance:none;
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: #fff;
      outline: none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }

    input[type="date"]:focus, select:focus{
      border-color: rgba(58,93,174,.55);
      box-shadow: 0 0 0 4px rgba(58,93,174,.16);
    }

    .btn{
      border: 1px solid rgba(27,54,93,.18);
      background: linear-gradient(180deg, rgba(58,93,174,.10), rgba(58,93,174,.06));
      color: var(--tslsj-navy);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 10px 18px rgba(58,93,174,.12);
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(58,93,174,.35);
      box-shadow: 0 14px 22px rgba(58,93,174,.16);
    }
    .btn:active{ transform: translateY(0px); }
    .btn:focus{
      outline:none;
      box-shadow: 0 0 0 4px rgba(58,93,174,.18), 0 14px 22px rgba(58,93,174,.16);
    }

    .btn.secondary{
      background: #fff;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }

    .btn.sage{
      background: linear-gradient(180deg, rgba(46,125,107,.14), rgba(46,125,107,.08));
      border-color: rgba(46,125,107,.22);
      color: #0E3B32;
      box-shadow: 0 10px 18px rgba(46,125,107,.12);
    }

    .muted{
      font-size: 12px;
      color: rgba(0,0,0,.55);
      margin-left: 4px;
    }

    .spacer{
      flex: 1 1 auto;
      min-width: 12px;
    }

    /* ===== Month (Tuesdays only) ===== */
    .month{
      margin: 16px 0 14px;
      background: var(--panel);
      border: 1px solid rgba(27,54,93,.10);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }

    .month-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .month-title{
      font-weight: 900;
      color: var(--tslsj-navy);
      letter-spacing: .2px;
    }

    .tuesday-list{
      display:grid;
      grid-template-columns: repeat(5, minmax(140px, 1fr));
      gap: 10px;
    }

    .tue-card{
      border-radius: 16px;
      padding: 10px 10px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      position: relative;
      overflow: hidden;
    }
    .tue-card::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, rgba(58,93,174,.10), rgba(46,125,107,.08), rgba(224,106,74,.06));
      opacity: .55;
      pointer-events:none;
      transform: translateY(-40%);
      filter: blur(14px);
    }
    .tue-card > *{ position: relative; }

    .tue-card:hover{
      transform: translateY(-1px);
      border-color: rgba(58,93,174,.28);
      box-shadow: 0 16px 26px rgba(0,0,0,.08);
    }
    .tue-card.is-selected{
      border-color: rgba(58,93,174,.50);
      box-shadow: 0 0 0 4px rgba(58,93,174,.14), 0 16px 26px rgba(0,0,0,.08);
    }
    .tue-date{
      font-weight: 900;
      color: var(--tslsj-navy);
      font-size: 14px;
      line-height: 1.15;
    }
    .tue-meta{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(0,0,0,.58);
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      font-weight: 800;
      font-size: 11px;
      color: rgba(0,0,0,.62);
    }
    .pill.sage{
      border-color: rgba(46,125,107,.22);
      background: rgba(46,125,107,.08);
      color: #0E3B32;
    }
    .pill.coral{
      border-color: rgba(224,106,74,.22);
      background: rgba(224,106,74,.10);
      color: #5A1F12;
    }

    /* ===== Grid container ===== */
    .matrix{
      border-radius: var(--r);
      overflow: auto; /* important pour sticky en responsive */
      border: 1px solid rgba(27,54,93,.10);
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(10px);
    }

    .matrix-header{
      display:grid;
      grid-template-columns: var(--timecol) repeat(4, 1fr);
      gap: 0;
      background: rgba(255,255,255,.9);
      border-bottom: 1px solid rgba(0,0,0,.08);

      position: sticky;
      top: 0;
      z-index: 8;
    }

    .matrix-header .cell{
      padding: 12px 12px;
      font-weight: 900;
      color: var(--tslsj-navy);
      border-right: 1px solid rgba(0,0,0,.06);
    }
    .matrix-header .cell:last-child{ border-right:none; }

    .matrix-body{
      display:grid;
      grid-template-columns: var(--timecol) repeat(4, 1fr);
      min-height: calc(var(--half) * 16); /* 9h -> 17h = 16 demi-heures */
    }

    .time-col{
      position: sticky;
      left: 0;
      z-index: 7;
      background: rgba(255,255,255,.92);
      border-right: 1px solid rgba(0,0,0,.06);
    }

    .time-slot{
      height: var(--half);
      display:flex;
      align-items:flex-start;
      justify-content:flex-end;
      padding: 10px 10px 0 8px;
      font-size: 12px;
      font-weight: 800;
      color: rgba(0,0,0,.58);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .cat-col{
      position: relative;
      border-right: 1px solid rgba(0,0,0,.06);
    }
    .cat-col:last-child{ border-right:none; }

    /* Lignes horizontales plus lisibles */
    .cat-col::before{
      content:"";
      position:absolute;
      inset:0;
      background: repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent calc(var(--half) - 1px),
        rgba(0,0,0,.12) calc(var(--half) - 1px),
        rgba(0,0,0,.12) var(--half)
      );
      pointer-events:none;
      opacity: .6;
    }

    /* ===== Event cards ===== */
    .event{
      position:absolute;
      left: 10px;
      right: 10px;
      border-radius: 16px;
      padding: 10px 12px;

      background: rgba(58,93,174,.08);
      border: 1px solid rgba(58,93,174,.16);
      box-shadow: 0 12px 20px rgba(27,54,93,.10);

      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
      cursor: pointer;
    }

    .event:hover{
      transform: translateY(-1px);
      border-color: rgba(58,93,174,.30);
      box-shadow: 0 16px 26px rgba(27,54,93,.14);
    }

    .event .t{
      font-weight: 900;
      font-size: 14px;
      color: var(--tslsj-navy);
      line-height: 1.22;
      letter-spacing: .1px;
    }

    .event .m{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(0,0,0,.62);
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .tag{
      margin-top: 8px;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 10.5px;
      font-weight: 900;
      letter-spacing: .25px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      color: rgba(0,0,0,.62);
    }

    /* CTA (lien) plus pro */
    .cta{
      margin-top: 10px;
      display:inline-flex;
      align-items:center;
      gap: 8px;

      font-size: 12px;
      font-weight: 900;
      text-decoration:none;

      padding: 8px 10px;
      border-radius: 999px;

      color: var(--tslsj-navy);
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(27,54,93,.18);
      box-shadow: 0 10px 16px rgba(0,0,0,.06);

      width: fit-content;
      pointer-events:auto;

      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      white-space: nowrap;
    }
    .cta:hover{
      transform: translateY(-1px);
      border-color: rgba(58,93,174,.35);
      box-shadow: 0 14px 22px rgba(0,0,0,.08);
      background: #fff;
    }
    .cta:focus{
      outline:none;
      box-shadow: 0 0 0 4px rgba(58,93,174,.16), 0 14px 22px rgba(0,0,0,.08);
    }

    .arrow{
      display:inline-block;
      transition: transform .12s ease;
    }
    .event:hover .arrow{ transform: translateX(2px); }

    /* Couleurs par catégorie (barre accent) */
    .event[data-cat="formation"]{
      background: rgba(58,93,174,.10);
      border-color: rgba(58,93,174,.20);
    }
    .event[data-cat="atelier"]{
      background: rgba(46,125,107,.10);
      border-color: rgba(46,125,107,.20);
    }
    .event[data-cat="webinaire"]{
      background: rgba(224,106,74,.12);
      border-color: rgba(224,106,74,.22);
    }
    .event[data-cat="conseils"]{
      background: rgba(27,54,93,.08);
      border-color: rgba(27,54,93,.16);
    }

    /* ===== Responsive ===== */
    @media (max-width: 980px){
      :root{ --half: 66px; }
      .tuesday-list{ grid-template-columns: repeat(3, minmax(140px, 1fr)); }
    }
    @media (max-width: 860px){
      :root{ --half: 62px; --timecol: 80px; }
      .matrix-header, .matrix-body{
        min-width: 980px; /* scroll horizontal propre */
      }
      .tuesday-list{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .bar label{ min-width: 160px; }
    }
    @media (max-width: 520px){
      h2{ font-size: 24px; }
      .tuesday-list{ grid-template-columns: 1fr; }
      .bar{ top: 8px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <h2>Les mardis Oriance Agora</h2>
    <p class="sub">
      Navigation rapide par <strong>mardi précédent / suivant</strong> et sélection dans <strong>Mardis du mois</strong>.
      (Les autres jours sont volontairement masqués dans la vue mensuelle.)
    </p>

    <div class="bar">
      <button class="btn secondary" id="prevTue" type="button">← Mardi d’avant</button>
      <button class="btn secondary" id="nextTue" type="button">Mardi suivant →</button>

      <label>Date (snap mardi) :
        <input id="date" type="date" />
      </label>

      <label>Filtre :
        <select id="filtre">
          <option value="">Tous</option>
        </select>
      </label>

      <button class="btn sage" id="reload" type="button">Recharger</button>

      <div class="spacer"></div>
      <span class="muted" id="status"></span>
    </div>

    <div class="month" aria-label="Mardis du mois">
      <div class="month-head">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" id="prevMonth" type="button">← Mois</button>
          <div class="month-title" id="monthTitle">Mardis du mois</div>
          <button class="btn secondary" id="nextMonth" type="button">Mois →</button>
        </div>
        <div class="muted" id="monthHint"></div>
      </div>
      <div class="tuesday-list" id="tuesdayList"></div>
    </div>

    <div class="matrix" id="grid">
      <div class="matrix-header" id="header"></div>
      <div class="matrix-body" id="body"></div>
    </div>
  </div>

  <script>
    // ====== WORKER CLOUDFLARE ======
    // Le token Airtable est maintenant sécurisé dans le Worker Cloudflare
    // Plus besoin de l'exposer ici!
    // =========================

    // Champs Airtable (noms exacts)
    const F_DATE = "Date activité";
    const F_TITLE = "Titre";
    const F_TYPE = "Type d’activité";

    // IMPORTANT: on se base sur heures réelles (pas SlotIndex)
    const F_START_TIME = "Heure début";
    const F_END_TIME   = "Heure fin";

    // Optionnel (si tu l’as)
    const F_TIME_LABEL = "Heure_affichage";

    const $ = (id) => document.getElementById(id);

    // Grille 09:00 -> 17:00, pas 30 minutes
    const START_MIN = 9*60;
    const END_MIN   = 17*60;
    const STEP_MIN  = 30;

    // Catégories affichées (4 colonnes)
    // (Tu peux renommer les titres sans casser le mapping)
    const CATEGORIES = [
      { key:"formation", label:"Formation" },
      { key:"atelier", label:"Atelier" },
      { key:"webinaire", label:"Webinaire" },
      { key:"conseils", label:"Conseils" },
    ];

    // ----- Utils dates -----
    function pad2(n){ return String(n).padStart(2,"0"); }

    function toYMD(v){
      if(!v) return "";
      if (typeof v === "string" && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
      const d = new Date(v);
      if (isNaN(d)) return "";
      return d.toISOString().slice(0,10);
    }

    function parseYMD(ymd){
      const [y,m,d] = ymd.split("-").map(Number);
      return new Date(y, m-1, d);
    }

    // Retourne la date (Date) du mardi de la semaine contenant d,
    // ou prochain/précédent selon dir (0=plus proche dans la semaine, +7/-7)
    function snapToTuesday(d){
      const day = d.getDay(); // 0=dim ... 2=mardi
      const delta = (2 - day); // vers mardi de la même semaine
      const nd = new Date(d);
      nd.setDate(d.getDate() + delta);
      return nd;
    }

    function addDays(d, n){
      const nd = new Date(d);
      nd.setDate(nd.getDate() + n);
      return nd;
    }

    function fmtHuman(d){
      const opts = { weekday:"long", year:"numeric", month:"long", day:"numeric" };
      return d.toLocaleDateString("fr-CA", opts);
    }

    function fmtMonthTitle(d){
      const opts = { month:"long", year:"numeric" };
      // fr-CA donne des libellés propres au Québec; adapte si tu veux fr-FR
      return d.toLocaleDateString("fr-CA", opts);
    }

    function isSameYMD(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    function getTuesdaysOfMonth(year, monthIndex){
      // monthIndex: 0..11
      const first = new Date(year, monthIndex, 1);
      const last  = new Date(year, monthIndex + 1, 0);
      const tuesdays = [];

      // trouver le premier mardi du mois
      const firstDay = first.getDay();
      const offset = (2 - firstDay + 7) % 7;
      let cur = new Date(year, monthIndex, 1 + offset);

      while(cur <= last){
        tuesdays.push(new Date(cur));
        cur = addDays(cur, 7);
      }
      return tuesdays;
    }

    // ----- Cat mapping (si ton champ Type d’activité contient des valeurs spécifiques) -----
    function normType(s){
      return String(s||"").toLowerCase().trim();
    }

    function catFromType(type){
      const t = normType(type);
      if (t.includes("formation")) return "formation";
      if (t.includes("atelier")) return "atelier";
      if (t.includes("webinaire") || t.includes("webinar")) return "webinaire";
      if (t.includes("conseil")) return "conseils";
      return null;
    }

    // ----- Time helpers -----
    function timeToMin(val){
      // accepte "HH:MM" ou "H:MM"
      if(!val) return null;
      const m = String(val).match(/(\d{1,2}):(\d{2})/);
      if(!m) return null;
      const hh = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      return hh*60 + mm;
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function minToTop(min){
      // Convertit minutes (ex: 9:30=570) en position px
      const idx = (min - START_MIN) / STEP_MIN;
      return idx * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--half'));
    }

    function durationToHeight(startMin, endMin){
      const dur = Math.max(STEP_MIN, endMin - startMin);
      const idx = dur / STEP_MIN;
      return idx * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--half')) - 10; // padding visuel
    }

    // ----- UI builders -----
    function buildHeader(){
      const h = $("header");
      h.innerHTML = "";

      const c0 = document.createElement("div");
      c0.className = "cell";
      c0.textContent = "Heure";
      h.appendChild(c0);

      for(const c of CATEGORIES){
        const el = document.createElement("div");
        el.className = "cell";
        el.textContent = c.label;
        h.appendChild(el);
      }
    }

    function buildBodySkeleton(){
      const b = $("body");
      b.innerHTML = "";

      // time column
      const timeCol = document.createElement("div");
      timeCol.className = "time-col";

      for(let t = START_MIN; t < END_MIN; t += STEP_MIN){
        const slot = document.createElement("div");
        slot.className = "time-slot";
        // affiche l'heure sur les heures pile seulement
        if(t % 60 === 0){
          const hh = Math.floor(t/60);
          slot.textContent = pad2(hh) + ":00";
        }else{
          slot.textContent = "";
        }
        timeCol.appendChild(slot);
      }

      b.appendChild(timeCol);

      // category columns
      for(const c of CATEGORIES){
        const col = document.createElement("div");
        col.className = "cat-col";
        col.dataset.cat = c.key;
        b.appendChild(col);
      }
    }

    function clearEvents(){
      for(const col of document.querySelectorAll(".cat-col")){
        col.querySelectorAll(".event").forEach(e => e.remove());
      }
    }

    function setStatus(msg){
      $("status").textContent = msg || "";
    }

    // ----- Month (Tuesdays only) UI -----
    function renderMonthPanel(){
      const selected = parseYMD($("date").value);
      const monthTitle = $("monthTitle");
      monthTitle.textContent = "Mardis — " + fmtMonthTitle(selected);

      const list = $("tuesdayList");
      list.innerHTML = "";

      const tuesdays = getTuesdaysOfMonth(selected.getFullYear(), selected.getMonth());
      $("monthHint").textContent = tuesdays.length ? (tuesdays.length + " mardis") : "";

      for(const d of tuesdays){
        const card = document.createElement("div");
        card.className = "tue-card" + (isSameYMD(d, selected) ? " is-selected" : "");
        card.tabIndex = 0;

        const title = document.createElement("div");
        title.className = "tue-date";
        // ex: mardi 3 mars 2026
        title.textContent = fmtHuman(d);
        card.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "tue-meta";

        const p1 = document.createElement("span");
        p1.className = "pill sage";
        p1.textContent = "Mardi";
        meta.appendChild(p1);

        const p2 = document.createElement("span");
        p2.className = "pill";
        p2.textContent = "Clique pour charger";
        meta.appendChild(p2);

        card.appendChild(meta);

        const ymd = toYMD(d);
        card.addEventListener("click", () => setTuesdayAndLoad(ymd));
        card.addEventListener("keydown", (ev) => {
          if(ev.key === "Enter" || ev.key === " "){
            ev.preventDefault();
            setTuesdayAndLoad(ymd);
          }
        });

        list.appendChild(card);
      }
    }

    function setTuesdayAndLoad(ymd){
      // snap + set input
      const d = snapToTuesday(parseYMD(ymd));
      const snapped = toYMD(d);
      $("date").value = snapped;
      renderMonthPanel();
      load();
    }

    // ----- Fetch Airtable via Worker -----
    async function fetchRecords(){
      const dateISO = $("date").value;
      const type = $("filtre").value;

      let formula = "DATETIME_FORMAT({" + F_DATE + "}, 'YYYY-MM-DD')='" + dateISO + "'";
      if (type) formula = "AND(" + formula + ", {" + F_TYPE + "}='" + type + "')";

      // IMPORTANT: remplace l'URL par ton endpoint Worker
      const url = new URL("https://flat-credit-0421.lcollard.workers.dev/"); // <-- à remettre comme dans ton code original
      url.searchParams.set("filterByFormula", formula);

      const res = await fetch(url.toString(), { method:"GET" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      return data.records || [];
    }

    // ----- Build filter options from records -----
    function populateFilter(records){
      const sel = $("filtre");
      const current = sel.value;
      const types = new Set();

      for(const r of records){
        const v = r?.fields?.[F_TYPE];
        if(v) types.add(v);
      }

      // rebuild options
      sel.innerHTML = '<option value="">Tous</option>';
      Array.from(types).sort().forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });

      // restore if still exists
      const exists = Array.from(sel.options).some(o => o.value === current);
      sel.value = exists ? current : "";
    }

    // ----- Render events -----
    function renderEvents(records){
      clearEvents();

      for(const rec of records){
        const f = rec.fields || {};
        const title = f[F_TITLE] || "(Sans titre)";
        const type = f[F_TYPE] || "";
        const cat = catFromType(type);

        // si pas de mapping, on ignore (ou on pourrait le mettre dans une colonne par défaut)
        if(!cat) continue;

        const startMin = timeToMin(f[F_START_TIME]);
        const endMin   = timeToMin(f[F_END_TIME]);

        if(startMin == null || endMin == null) continue;

        const s = clamp(startMin, START_MIN, END_MIN);
        const e = clamp(endMin,   START_MIN, END_MIN);
        if(e <= s) continue;

        const col = document.querySelector('.cat-col[data-cat="'+cat+'"]');
        if(!col) continue;

        const ev = document.createElement("div");
        ev.className = "event";
        ev.dataset.cat = cat;

        const top = minToTop(s) + 8; // padding visuel
        const height = durationToHeight(s, e);

        ev.style.top = top + "px";
        ev.style.height = height + "px";

        const t = document.createElement("div");
        t.className = "t";
        t.textContent = title;
        ev.appendChild(t);

        const meta = document.createElement("div");
        meta.className = "m";

        // libellé horaire
        const timeLabel = f[F_TIME_LABEL] || (String(f[F_START_TIME]||"") + " – " + String(f[F_END_TIME]||""));
        const pill1 = document.createElement("span");
        pill1.className = "pill";
        pill1.textContent = timeLabel;
        meta.appendChild(pill1);

        // type
        if(type){
          const pill2 = document.createElement("span");
          pill2.className = "pill coral";
          pill2.textContent = type;
          meta.appendChild(pill2);
        }

        ev.appendChild(meta);

        const tag = document.createElement("div");
        tag.className = "tag";
        tag.textContent = "Oriance Agora";
        ev.appendChild(tag);

        // CTA (si tu as un lien dans tes champs, adapte ici)
        // Exemple: si tu as f["Lien"] ou f["URL"]
        const urlField = f["Lien"] || f["URL"] || "";
        if(urlField){
          const a = document.createElement("a");
          a.className = "cta";
          a.href = urlField;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = "Détails";
          const arrow = document.createElement("span");
          arrow.className = "arrow";
          arrow.textContent = "→";
          a.appendChild(arrow);
          ev.appendChild(a);
        }

        col.appendChild(ev);
      }
    }

    // ----- Main load -----
    async function load(){
      try{
        setStatus("Chargement…");
        const records = await fetchRecords();

        // Rebuild filter options based on the full set for the chosen day
        populateFilter(records);

        renderEvents(records);

        const d = parseYMD($("date").value);
        setStatus("Affiché: " + fmtHuman(d) + " • " + records.length + " enregistrements");
      }catch(e){
        setStatus("Erreur: " + e.message);
        console.error(e);
      }
    }

    // ----- Navigation handlers -----
    function gotoPrevTuesday(){
      const d = snapToTuesday(parseYMD($("date").value));
      setTuesdayAndLoad(toYMD(addDays(d, -7)));
    }
    function gotoNextTuesday(){
      const d = snapToTuesday(parseYMD($("date").value));
      setTuesdayAndLoad(toYMD(addDays(d, +7)));
    }

    function gotoPrevMonth(){
      const d = parseYMD($("date").value);
      const nd = new Date(d.getFullYear(), d.getMonth()-1, d.getDate());
      setTuesdayAndLoad(toYMD(snapToTuesday(nd)));
    }
    function gotoNextMonth(){
      const d = parseYMD($("date").value);
      const nd = new Date(d.getFullYear(), d.getMonth()+1, d.getDate());
      setTuesdayAndLoad(toYMD(snapToTuesday(nd)));
    }

    // ----- Init -----
    function init(){
      buildHeader();
      buildBodySkeleton();

      // Date par défaut: mardi de la semaine en cours (snap)
      const today = new Date();
      const tue = snapToTuesday(today);
      $("date").value = toYMD(tue);

      // Bind
      $("reload").addEventListener("click", load);
      $("filtre").addEventListener("change", load);

      $("prevTue").addEventListener("click", gotoPrevTuesday);
      $("nextTue").addEventListener("click", gotoNextTuesday);

      $("prevMonth").addEventListener("click", gotoPrevMonth);
      $("nextMonth").addEventListener("click", gotoNextMonth);

      // Si l’utilisateur choisit une date quelconque, on snap au mardi
      $("date").addEventListener("change", () => {
        const d = snapToTuesday(parseYMD($("date").value));
        $("date").value = toYMD(d);
        renderMonthPanel();
        load();
      });

      renderMonthPanel();
      load();
    }

    init();
  </script>
</body>
</html>
